export default async function handler(req,res){
  if (req.method !== 'POST') return res.status(405).end()
  const { roomId } = req.body
  const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL
  const SERVICE = process.env.SUPABASE_SERVICE_ROLE_KEY
  try {
    // mark room.status = 'running'
    const r = await fetch(`${SUPABASE_URL}/rest/v1/rooms`, {
      method: 'PATCH',
      headers: { apikey: SERVICE, Authorization: `Bearer ${SERVICE}`, 'Content-Type':'application/json', Prefer: 'return=representation' },
      body: JSON.stringify({ status: 'running' }),
    })
    // Note: adjust filter to room id if you want exact update â€” we keep simple for single room
    // Better: use rpc or filter: use PostgREST filter param ?id=eq.<roomId>
    // We'll call with query:
    const r2 = await fetch(`${SUPABASE_URL}/rest/v1/rooms?id=eq.${roomId}`, {
      method: 'PATCH',
      headers: { apikey: SERVICE, Authorization: `Bearer ${SERVICE}`, 'Content-Type':'application/json', Prefer: 'return=representation' },
      body: JSON.stringify({ status: 'running' }),
    })
    if (!r2.ok) {
      const txt = await r2.text()
      return res.status(500).json({ ok:false, error: txt })
    }
    return res.json({ ok:true })
  } catch (err) { return res.status(500).json({ ok:false, error: err.message }) }
}
